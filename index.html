<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Visualizador - data (hoja "data")</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>


    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 12px; background:#f6f8fb; color:#222; }
        header { background-color:#1721BF; padding:12px 0; text-align:center; color:#fff; font-family:'DIN', 'DIN Alternate', sans-serif; }
        header h1 { margin:0; font-size:20px; font-weight:700; line-height:1.2em; }
        .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:12px 0; }
        .controls select, .controls input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid #d0d7de; font-size:14px; min-width:140px; }
        .controls .search-box { min-width:200px; max-width:320px; width:40vw; }
        .table-wrapper { background:#fff; border-radius:10px; padding:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow-x:auto; margin-bottom:20px; }
        table.dataTable.no-footer { border-bottom: none; }
        table.dataTable tbody tr:hover { background:#f1f5fb; }
        .diff-zero { color:#FFD700; font-weight:bold; margin-left:4px; }
        .diff-negative { color:#FF0000; font-weight:bold; margin-left:4px; }
        .diff-positive { color:#00AA00; font-weight:bold; margin-left:4px; }
        .chart-container { width:100%; max-width:1000px; margin: auto; padding:10px; background:#fff; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .chart-container canvas { width:100% !important; height:400px !important; }
        @media (max-width: 600px) { .controls select, .controls input[type="text"] { font-size:13px; padding:10px; } header h1 { font-size:18px; } }
        
        /* Estilos para el texto din√°mico */
        .dynamic-text-container {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #dynamicText {
            font-family: 'Arial Black', sans-serif;
            font-size: 2.5em;
            color: #1721BF; 
            animation: fadeInOut 3s infinite; 
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Oculta los contenedores al inicio */
        .hidden-content {
            display: none;
        }
    </style>
</head>
<body>

<header>
    <h1>üéÖüéÑüéÅ RACHA NAVIDE√ëA DIRECTO üéÖüéÑüéÅ</h1>
</header>

<div class="dynamic-text-container">
    <h2 id="dynamicText"></h2>
</div>

<div class="controls">
    <input id="filterMovil" class="search-box" type="text" placeholder="Buscar MOVIL (exacto)"/>
    <button id="searchButton" style="padding:8px 10px;border-radius:8px;border:1px solid #d0d7de;background:#fff;cursor:pointer;">Buscar</button>
</div>

<div id="contentContainer" class="hidden-content">
    <div class="controls" aria-hidden="false">
        <select id="filterSemana"><option value="">Semana: Todas</option></select>
        <select id="filterFlota"><option value="">FLOTA: Todas</option></select>
        <button id="clearFilters" style="padding:8px 10px;border-radius:8px;border:1px solid #d0d7de;background:#fff;cursor:pointer;">Limpiar</button>
    </div>

    <div class="table-wrapper">
        <table id="dataTable" class="display nowrap" style="width:100%">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbodyRows"></tbody>
        </table>
    </div>

    <div class="chart-container">
        <canvas id="chartServicios"></canvas>
    </div>
</div>

<script>
function normalize(s){ if(s === undefined || s === null) return ""; return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g,'').replace(/[^a-zA-Z0-9_./-]/g,'').toLowerCase(); }
function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

let chartServicios;
let dataTable;
let rawData; // Variable para almacenar los datos brutos del Excel
let idxSemana, idxFlota, idxMovil, idxServicios, idxMeta;


// Script para el texto din√°mico
document.addEventListener("DOMContentLoaded", function() {
    const dynamicTexts = ["Premios !!!", "Pavo!!", "Canasta!!"];
    let textIndex = 0;
    const dynamicTextElement = document.getElementById("dynamicText");

    function changeText() {
        dynamicTextElement.textContent = dynamicTexts[textIndex];
        textIndex = (textIndex + 1) % dynamicTexts.length;
    }

    setInterval(changeText, 3000); // Cambia el texto cada 3 segundos
    changeText(); // Inicia el texto inmediatamente
});


$(document).ready(function(){
    fetch('data.xlsx')
        .then(r => { if(!r.ok) throw new Error('No se pudo descargar data.xlsx'); return r.arrayBuffer(); })
        .then(ab => {
            const workbook = XLSX.read(ab, {type:'array'});
            const sheetName = workbook.SheetNames.includes('data') ? 'data' : workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            rawData = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
            if(!rawData || rawData.length<1){ alert('La hoja est√° vac√≠a o no tiene encabezados.'); return; }

            setupTableAndFilters(rawData);
        })
        .catch(err=>{ console.error(err); alert('Error cargando data.xlsx: '+err.message); });

    function setupTableAndFilters(rows) {
        const headers = rows[0].map(h => h===null?"":h);
        const thead = $('#theadRow'); thead.empty();
        
        const allowedHeaders = ['Estado', 'Semana', 'M√≥vil', 'FLOTA', 'Servicios', 'Meta', 'Diferencia'];
        
        const headerIndexes = {};
        const displayHeaders = [];
        headers.forEach((h, i) => {
            if (allowedHeaders.includes(h)) {
                headerIndexes[normalize(h)] = i;
                displayHeaders.push(h);
                thead.append('<th>'+ (h||'') + '</th>');
            }
        });

        const tbody = $('#tbodyRows'); tbody.empty();
        for(let i=1;i<rows.length;i++){
            let tr='<tr>';
            displayHeaders.forEach(h => {
                const originalIndex = headers.indexOf(h);
                let cell = rows[i][originalIndex] === undefined ? '' : rows[i][originalIndex];

                if (normalize(h) === 'diferencia') {
                    let val = parseFloat(cell);
                    if (isNaN(val) || val === 0) cell = cell + ' <span class="diff-zero">‚Äî</span>';
                    else if (val < 0) cell = cell + ' <span class="diff-negative">‚ñº</span>';
                    else cell = cell + ' <span class="diff-positive">‚ñ≤</span>';
                }
                tr += '<td>'+cell+'</td>';
            });
            tr+='</tr>'; 
            tbody.append(tr);
        }

        if(dataTable) dataTable.destroy();
        dataTable = $('#dataTable').DataTable({ responsive:false, scrollX:true, pageLength:25, lengthMenu:[10,25,50,100], order:[] });

        const headerNorm = headers.map(h => normalize(h));
        function idxOf(names){ for(const nm of names){ const target = normalize(nm); const idx = headerNorm.findIndex(hn => hn===target||hn.includes(target)||target.includes(hn)); if(idx!==-1) return idx; } return -1; }

        idxSemana = idxOf(['Semana','semana']);
        idxFlota = idxOf(['FLOTA','Flota','flota']);
        idxMovil = idxOf(['M√≥vil','Movil','MOVIL','movil']);
        idxServicios = idxOf(['Servicios','servicios']);
        idxMeta = idxOf(['Meta','meta']);

        function uniqueValuesAt(idx){ if(idx<0) return []; const s=new Set(); for(let i=1;i<rows.length;i++) s.add(String(rows[i][idx]??'').trim()); return Array.from(s).filter(x=>x!=='').sort((a,b)=>a.localeCompare(b+'')); }
        const semanas = uniqueValuesAt(idxSemana), flotas = uniqueValuesAt(idxFlota);
        const $fSemana=$('#filterSemana'), $fFlota=$('#filterFlota');
        $fSemana.empty().append('<option value="">Semana: Todas</option>');
        $fFlota.empty().append('<option value="">FLOTA: Todas</option>');
        semanas.forEach(v=>$fSemana.append(`<option value="${v}">${v}</option>`));
        flotas.forEach(v=>$fFlota.append(`<option value="${v}">${v}</option>`));

        function applyFilters(){
            if(idxSemana>=0){ const val=$('#filterSemana').val(); dataTable.column(idxSemana).search(val?'^'+escapeRegex(val)+'$':'',true,false); }
            if(idxFlota>=0){ const val=$('#filterFlota').val(); dataTable.column(idxFlota).search(val?'^'+escapeRegex(val)+'$':'',true,false); }
            
            dataTable.draw();
            updateChartServicios();
        }

        $('#filterSemana,#filterFlota').on('change',applyFilters);
        $('#clearFilters').on('click',()=>{ $('#filterSemana,#filterFlota').val(''); applyFilters(); });


        $('#searchButton').on('click', function() {
            const mv = $('#filterMovil').val();
            if (mv) {
                // Muestra el contenido
                $('#contentContainer').show();

                // Filtra la tabla y actualiza
                dataTable.column(idxMovil).search('^' + escapeRegex(mv) + '$', true, false, true);
                dataTable.draw();
                updateChartServicios();
            } else {
                alert('Por favor, ingrese un n√∫mero de m√≥vil.');
            }
        });
        
        // Agregamos el evento de ordenamiento a la tabla
        dataTable.on('order.dt', function() {
            updateChartServicios();
        });

        function updateChartServicios(){
            const filteredData = dataTable.rows({search:'applied', order:'applied'}).data().toArray();
            
            const groupedData = {};
            filteredData.forEach(row => {
                const key = `${row[idxFlota]} | SEM.${row[idxSemana]}`;
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        servicios: 0,
                        metas: [],
                        originalOrder: -1 // Guardamos el orden original para mantenerlo
                    };
                }
                groupedData[key].servicios += parseFloat(row[idxServicios] ?? 0);
                groupedData[key].metas.push(parseFloat(row[idxMeta] ?? 0));
            });
            
            // Obtenemos los datos ordenados del DataTables
            const labels = dataTable.rows({search:'applied', order:'applied'}).data().toArray().map(row => `${row[idxFlota]} | SEM.${row[idxSemana]}`);
            const uniqueLabels = [...new Set(labels)]; // Eliminamos duplicados
            
            // Reordenamos los datos para el gr√°fico seg√∫n el nuevo orden de la tabla
            const servicios = uniqueLabels.map(key => groupedData[key]?.servicios ?? 0);
            const promedioMetas = uniqueLabels.map(key => {
                const metas = groupedData[key]?.metas ?? [];
                const sum = metas.reduce((a, b) => a + b, 0);
                return metas.length > 0 ? sum / metas.length : 0;
            });


            const ctx = document.getElementById('chartServicios').getContext('2d');
            if(chartServicios) chartServicios.destroy();

            Chart.register(ChartDataLabels);

            chartServicios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: uniqueLabels,
                    datasets: [
                        { 
                            type:'bar', 
                            label:'Suma de Servicios', 
                            data: servicios, 
                            backgroundColor:'#D3D3D3', 
                            order: 2, 
                            datalabels: {
                                align: 'end',
                                anchor: 'start',
                                formatter: (value) => {
                                    return value.toFixed(0); 
                                }
                            }
                        },
                        { 
                            type:'line', 
                            label:'Promedio de Meta', 
                            data: promedioMetas, 
                            borderColor:'#76FF03', 
                            backgroundColor:'#76FF03', 
                            borderWidth: 3, 
                            fill:false, 
                            pointRadius: 5, 
                            pointStyle: 'circle', 
                            order: 1, 
                            datalabels: {
                                align: 'end',
                                anchor: 'end',
                                formatter: (value) => {
                                    return value.toFixed(0); 
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive:true,
                    maintainAspectRatio:false,
                    interaction: { mode:'index', intersect:false },
                    plugins:{ 
                        legend:{ display:true },
                        tooltip: { 
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(0);
                                    return label;
                                }
                            }
                        }
                    },
                    scales:{ 
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y:{ 
                            beginAtZero:true, 
                            title:{ display:true, text:'Cantidad' },
                            max: Math.max(...servicios, ...promedioMetas) * 1.2,
                        }
                    }
                }
            });
        }
    }
});
</script>

</body>
</html>
