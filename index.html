<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visualizador - data (hoja "data")</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS, jQuery y DataTables (responsive) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 12px; background:#f6f8fb; color:#222; }
    
    header {
      background-color:#1721BF; 
      padding:12px 0; 
      text-align:center; 
      color:#fff; 
      font-family:'DIN', 'DIN Alternate', sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    header h1 { margin:0; font-size:20px; font-weight:700; }

    .controls {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin:12px 0;
    }

    .controls select, .controls input[type="text"] {
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #d0d7de;
      font-size:14px;
      min-width:140px;
    }

    .controls .search-box { min-width:200px; max-width:320px; width:40vw; }

    .table-wrapper {
      background:#fff;
      border-radius:10px;
      padding:8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      overflow-x:auto;
    }

    table.dataTable.no-footer { border-bottom: none; }
    table.dataTable tbody tr:hover { background:#f1f5fb; }

    /* Encabezados con fondo azul y texto blanco */
    table.dataTable thead th {
      background-color: #1721BF !important;
      color: #fff !important;
      font-weight: bold;
    }

    /* Iconos diferencia */
    .diff-zero { color:#FFD700; font-weight:bold; margin-left:4px; } /* Amarillo */
    .diff-negative { color:#FF0000; font-weight:bold; margin-left:4px; } /* Rojo */
    .diff-positive { color:#00AA00; font-weight:bold; margin-left:4px; } /* Verde */

    @media (max-width: 600px) {
      .controls select, .controls input[type="text"] { font-size:13px; padding:10px; }
      header h1 { font-size:18px; }
    }
  </style>
</head>
<body>

<header>
  <span>üéÑ</span>
  <h1>CUMPLIMIENTO RACHA NAVIDE√ëA</h1>
  <span>üéÅ</span>
</header>

<div class="controls" aria-hidden="false">
  <select id="filterSemana"><option value="">Semana: Todas</option></select>
  <select id="filterOperacion"><option value="">Operaci√≥n: Todas</option></select>
  <select id="filterFlota"><option value="">FLOTA: Todas</option></select>
  <input id="filterMovil" class="search-box" type="text" placeholder="Buscar MOVIL (din√°mico)"/>
  <button id="clearFilters" style="padding:8px 10px;border-radius:8px;border:1px solid #d0d7de;background:#fff;cursor:pointer;">Limpiar</button>
</div>

<div class="table-wrapper">
  <table id="dataTable" class="display nowrap" style="width:100%">
    <thead><tr id="theadRow"></tr></thead>
    <tbody id="tbodyRows"></tbody>
  </table>
</div>

<script>
function normalize(s){
  if(s === undefined || s === null) return "";
  return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g,'').replace(/[^a-zA-Z0-9_./-]/g,'').toLowerCase();
}
function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

$(document).ready(function(){
  fetch('data.xlsx')
    .then(r => { if(!r.ok) throw new Error('No se pudo descargar data.xlsx'); return r.arrayBuffer(); })
    .then(ab => {
      const workbook = XLSX.read(ab, {type:'array'});
      const sheetName = workbook.SheetNames.includes('data') ? 'data' : workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});

      if(!rows || rows.length<1){ alert('La hoja est√° vac√≠a o no tiene encabezados.'); return; }

      const headers = rows[0].map(h => h===null?"":h);
      const thead = $('#theadRow'); thead.empty();
      headers.forEach(h => thead.append('<th>'+ (h||'') + '</th>'));

      const tbody = $('#tbodyRows'); tbody.empty();
      for(let i=1;i<rows.length;i++){
        let tr='<tr>';
        for(let j=0;j<headers.length;j++){
          let cell = rows[i][j]===undefined?'':rows[i][j];

          // Formato moneda S/ para Producci√≥n S/.
          if(normalize(headers[j]) === 'produccions/.') {
            let num = parseFloat(cell);
            if(!isNaN(num)){
              cell = 'S/ ' + num.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
            }
          }

          // Iconos Diferencia: mostrar n√∫mero + icono
          if(normalize(headers[j]) === 'diferencia'){
            let val = parseFloat(cell);
            if(isNaN(val) || val===0) cell = cell + ' <span class="diff-zero">‚Äî</span>';
            else if(val < 0) cell = cell + ' <span class="diff-negative">‚ñº</span>';
            else cell = cell + ' <span class="diff-positive">‚ñ≤</span>';
          }

          tr += '<td>'+cell+'</td>';
        }
        tr+='</tr>'; 
        tbody.append(tr);
      }

      const headerNorm = headers.map(h => normalize(h));
      function idxOf(names){ for(const nm of names){ const target = normalize(nm); const idx = headerNorm.findIndex(hn => hn===target||hn.includes(target)||target.includes(hn)); if(idx!==-1) return idx; } return -1; }

      const idxSemana = idxOf(['Semana','semana']);
      const idxOperacion = idxOf(['Operaci√≥n','Operacion','operacion','operaciones']);
      const idxFlota = idxOf(['FLOTA','Flota','flota']);
      const idxMovil = idxOf(['M√≥vil','Movil','MOVIL','movil']);

      function uniqueValuesAt(idx){ if(idx<0) return []; const s=new Set(); for(let i=1;i<rows.length;i++) s.add(String(rows[i][idx]??'').trim()); return Array.from(s).filter(x=>x!=='').sort((a,b)=>a.localeCompare(b+'')); }
      const semanas = uniqueValuesAt(idxSemana), operaciones=uniqueValuesAt(idxOperacion), flotas=uniqueValuesAt(idxFlota);
      const $fSemana=$('#filterSemana'), $fOperacion=$('#filterOperacion'), $fFlota=$('#filterFlota');
      semanas.forEach(v=>$fSemana.append(`<option value="${v}">${v}</option>`));
      operaciones.forEach(v=>$fOperacion.append(`<option value="${v}">${v}</option>`));
      flotas.forEach(v=>$fFlota.append(`<option value="${v}">${v}</option>`));

      let dataTable = $.fn.dataTable.isDataTable('#dataTable') ? $('#dataTable').DataTable().clear().destroy() : null;
      dataTable = $('#dataTable').DataTable({ 
        responsive:false,
        scrollX:true,     
        pageLength:25, 
        lengthMenu:[10,25,50,100], 
        order:[] 
      });

      function applyFilters(){
        if(idxSemana>=0){ const val=$('#filterSemana').val(); dataTable.column(idxSemana).search(val?'^'+escapeRegex(val)+'$':'',true,false); }
        if(idxOperacion>=0){ const val=$('#filterOperacion').val(); dataTable.column(idxOperacion).search(val?'^'+escapeRegex(val)+'$':'',true,false); }
        if(idxFlota>=0){ const val=$('#filterFlota').val(); dataTable.column(idxFlota).search(val?'^'+escapeRegex(val)+'$':'',true,false); }
        if(idxMovil>=0){ const mv=$('#filterMovil').val(); dataTable.column(idxMovil).search(mv?mv:'', false,true,true); }
        dataTable.draw();
      }

      $('#filterSemana,#filterOperacion,#filterFlota').on('change',applyFilters);
      $('#filterMovil').on('input',applyFilters);
      $('#clearFilters').on('click',()=>{ $('#filterSemana,#filterOperacion,#filterFlota,#filterMovil').val(''); applyFilters(); });

    })
    .catch(err=>{ console.error(err); alert('Error cargando data.xlsx: '+err.message); });
});
</script>

</body>
</html>
